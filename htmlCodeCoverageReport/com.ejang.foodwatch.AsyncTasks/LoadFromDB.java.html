<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoadFromDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ejang.foodwatch.AsyncTasks</a> &gt; <span class="el_source">LoadFromDB.java</span></div><h1>LoadFromDB.java</h1><pre class="source lang-java linenums">package com.ejang.foodwatch.AsyncTasks;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.AsyncTask;

import com.ejang.foodwatch.Activities.BrowseActivity;
import com.ejang.foodwatch.BuildConfig;
import com.ejang.foodwatch.SQLDB.DatabaseContract;
import com.ejang.foodwatch.Utils.InspectionResult;
import com.ejang.foodwatch.Utils.Restaurant;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;


// Asynchronous task for loading all restaurant and inspection data from the SQLite DB. This task
// is called when a user has fetched data from the City of Surrey database in the past week.
public class LoadFromDB extends AsyncTask&lt;SQLiteDatabase, Void, Void&gt; {

    private BrowseActivity activity;
    private HashMap&lt;String, ArrayList&lt;InspectionResult&gt;&gt; inspectionDataToReturn;
    private ArrayList&lt;Restaurant&gt; restaurantDataToReturn;

    public LoadFromDB(BrowseActivity activity)
<span class="fc" id="L28">    {</span>
        // Only BrowseActivity will directly call this constructor, so we can access its fields.
<span class="fc" id="L30">        this.activity = activity;</span>
<span class="fc" id="L31">        inspectionDataToReturn = new HashMap&lt;&gt;();</span>
<span class="fc" id="L32">        restaurantDataToReturn = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L33">    }</span>

    @Override
    protected Void doInBackground(SQLiteDatabase... params) {

<span class="pc bpc" id="L38" title="1 of 2 branches missed.">        while (!activity.dataAndAdapterAvailable.get())</span>
        {
            try {
<span class="nc" id="L41">                Thread.sleep(500);</span>
<span class="nc" id="L42">            } catch (InterruptedException e) {</span>
<span class="nc" id="L43">                e.printStackTrace();</span>
<span class="nc" id="L44">            }</span>
        }
<span class="fc" id="L46">        activity.dataAndAdapterAvailable.set(false);</span>

<span class="fc" id="L48">        SQLiteDatabase writeableDB = params[0];</span>

        // Projection set up for better readability. Also will come in handy if I don't need to get
        // every column from the table in the future.
<span class="fc" id="L52">        String[] projectionRestaurant =</span>
                {
                        DatabaseContract.RestaurantTable.COLUMN_TRACKING_ID,
                        DatabaseContract.RestaurantTable.COLUMN_RES_NAME,
                        DatabaseContract.RestaurantTable.COLUMN_RES_ADDRESS,
                        DatabaseContract.RestaurantTable.COLUMN_RES_LAT,
                        DatabaseContract.RestaurantTable.COLUMN_RES_LONG
                };

<span class="fc" id="L61">        String[] projectionInspection =</span>
                {
                        DatabaseContract.InspectionTable.COLUMN_TRACKING_ID,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_DATE,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_TYPE,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_VIOLLUMP,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_HAZARD,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_NUM_CRIT,
                        DatabaseContract.InspectionTable.COLUMN_INSPECTION_NUM_NONCRIT
                };

        // Add all inspection data from the database to the global hashmap BrowserActivity.inspectionData
<span class="fc" id="L73">        Cursor inspectionCursor = writeableDB.query(DatabaseContract.InspectionTable.INSPECTION_TABLE_NAME, null, null, null, null, null, null);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        while (inspectionCursor.moveToNext())</span>
        {
<span class="fc" id="L76">            String trackingID = inspectionCursor.getString(inspectionCursor.getColumnIndexOrThrow(projectionInspection[0]));</span>
<span class="fc" id="L77">            String date = inspectionCursor.getString(inspectionCursor.getColumnIndexOrThrow(projectionInspection[1]));</span>
<span class="fc" id="L78">            String type = inspectionCursor.getString(inspectionCursor.getColumnIndexOrThrow(projectionInspection[2]));</span>
<span class="fc" id="L79">            String violLump = inspectionCursor.getString(inspectionCursor.getColumnIndexOrThrow(projectionInspection[3]));</span>
<span class="fc" id="L80">            String hazard = inspectionCursor.getString(inspectionCursor.getColumnIndexOrThrow(projectionInspection[4]));</span>
<span class="fc" id="L81">            Integer numCrit = inspectionCursor.getInt(inspectionCursor.getColumnIndexOrThrow(projectionInspection[5]));</span>
<span class="fc" id="L82">            Integer numNonCrit = inspectionCursor.getInt(inspectionCursor.getColumnIndexOrThrow(projectionInspection[6]));</span>

<span class="fc" id="L84">            addInspectionToMap(new InspectionResult(trackingID, date, type, violLump, hazard, numCrit, numNonCrit));</span>
<span class="fc" id="L85">        }</span>
<span class="fc" id="L86">        inspectionCursor.close();</span>
<span class="fc" id="L87">        activity.setInspectionData(inspectionDataToReturn);</span>

        // Wait until location is set in the UI thread to initialize restaurant data because they
        // need the distance from the user's chosen location.
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        while (!activity.locationSet.get())</span>
        {
            try {
<span class="nc" id="L94">                Thread.sleep(500);</span>
<span class="nc" id="L95">            } catch (InterruptedException e) {</span>
<span class="nc" id="L96">                e.printStackTrace();</span>
<span class="nc" id="L97">            }</span>
        }

        // Add all restaurant data from the database to the global array BrowserActivity.allRestaurants
<span class="fc" id="L101">        Cursor cursor = writeableDB.query(DatabaseContract.RestaurantTable.RES_TABLE_NAME, null, null, null, null, null, null);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        while (cursor.moveToNext())</span>
        {
<span class="fc" id="L104">            String trackingID = cursor.getString(cursor.getColumnIndexOrThrow(projectionRestaurant[0]));</span>
<span class="fc" id="L105">            String resName = cursor.getString(cursor.getColumnIndexOrThrow(projectionRestaurant[1]));</span>
<span class="fc" id="L106">            String address = cursor.getString(cursor.getColumnIndexOrThrow(projectionRestaurant[2]));</span>
<span class="fc" id="L107">            Double latitude = cursor.getDouble(cursor.getColumnIndexOrThrow(projectionRestaurant[3]));</span>
<span class="fc" id="L108">            Double longitude = cursor.getDouble(cursor.getColumnIndexOrThrow(projectionRestaurant[4]));</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (inspectionDataToReturn.containsKey(trackingID))</span>
            {
<span class="fc" id="L112">                restaurantDataToReturn.add(new Restaurant(resName, address, latitude,</span>
<span class="fc" id="L113">                        longitude, trackingID, inspectionDataToReturn.get(trackingID)));</span>
            }
            else
            {
<span class="fc" id="L117">                restaurantDataToReturn.add(new Restaurant(resName, address, latitude,</span>
                        longitude, trackingID, null));
            }
<span class="fc" id="L120">        }</span>
<span class="fc" id="L121">        cursor.close();</span>

        // Sort the restaurants by distance from user's selected location and return
<span class="fc" id="L124">        Collections.sort(restaurantDataToReturn, new Comparator&lt;Restaurant&gt;() {</span>
            @Override
            public int compare(Restaurant o1, Restaurant o2) {
<span class="fc" id="L127">                return o1.distanceFromUser.compareTo(o2.distanceFromUser);</span>
            }
        });

<span class="fc" id="L131">        activity.setRestaurantData(restaurantDataToReturn);</span>

<span class="fc" id="L133">        return null;</span>
    }

    // Called when background task finishes.
    @Override
    protected void onPostExecute(Void v)
    {
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (!activity.updateCheckerStarted)</span>
        {
<span class="fc" id="L142">            activity.startUpdateChecker();</span>
        }
<span class="fc" id="L144">        activity.initializeListView();</span>
<span class="fc" id="L145">    }</span>

    private void addInspectionToMap(InspectionResult inspection)
    {
        // If trackingID key exists, add it. If not, create new key.
<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (inspectionDataToReturn.containsKey(inspection.trackingID))</span>
        {
<span class="fc" id="L152">            ArrayList&lt;InspectionResult&gt; inspections = inspectionDataToReturn.get(inspection.trackingID);</span>
<span class="fc" id="L153">            Integer initialSize = inspections.size();</span>
            // This loop ensures that the inspections for the same key (trackingID) are organized by the date.
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">            for (int i = 0 ; i &lt;= initialSize ; i++)</span>
            {
<span class="fc bfc" id="L157" title="All 2 branches covered.">                if (i == initialSize)</span>
                {
<span class="fc" id="L159">                    inspections.add(inspection);</span>
<span class="fc" id="L160">                    break;</span>
                }
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">                if (BuildConfig.DEBUG)</span>
                {
                    // For debug builds, the inspections are organized from oldest to newest. This
                    // is for testing purposes to avoid dealing with NetstedScrollView and Espresso.
<span class="fc bfc" id="L166" title="All 2 branches covered.">                    if(inspections.get(i).inspectionDate.after(inspection.inspectionDate))</span>
                    {
<span class="fc" id="L168">                        inspections.add(i, inspection);</span>
<span class="fc" id="L169">                        break;</span>
                    }
                }
                else
                {
                    // For all other builds, the inspections are organized from newest to oldest.
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    if(inspections.get(i).inspectionDate.before(inspection.inspectionDate))</span>
                    {
<span class="nc" id="L177">                        inspections.add(i, inspection);</span>
<span class="nc" id="L178">                        break;</span>
                    }
                }
            }
<span class="fc" id="L182">        }</span>
        else
        {
<span class="fc" id="L185">            ArrayList&lt;InspectionResult&gt; inspectionResults = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L186">            inspectionResults.add(inspection);</span>
<span class="fc" id="L187">            inspectionDataToReturn.put(inspection.trackingID, inspectionResults);</span>
        }
<span class="fc" id="L189">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>