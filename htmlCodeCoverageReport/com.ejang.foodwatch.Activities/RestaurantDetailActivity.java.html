<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestaurantDetailActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ejang.foodwatch.Activities</a> &gt; <span class="el_source">RestaurantDetailActivity.java</span></div><h1>RestaurantDetailActivity.java</h1><pre class="source lang-java linenums">package com.ejang.foodwatch.Activities;

import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.support.design.widget.AppBarLayout;
import android.support.design.widget.CoordinatorLayout;
import android.support.v7.app.AlertDialog;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.Toolbar;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.ejang.foodwatch.R;
import com.ejang.foodwatch.Utils.HazardRating;
import com.ejang.foodwatch.Utils.InspectionResult;
import com.ejang.foodwatch.Views.InspectionListAdapter;
import com.ejang.foodwatch.Views.ViolationListAdapter;
import com.google.android.gms.maps.CameraUpdate;
import com.google.android.gms.maps.CameraUpdateFactory;
import com.google.android.gms.maps.GoogleMap;
import com.google.android.gms.maps.MapFragment;
import com.google.android.gms.maps.OnMapReadyCallback;
import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.MarkerOptions;

import java.util.ArrayList;
import java.util.HashMap;

<span class="fc" id="L37">public class RestaurantDetailActivity extends AppCompatActivity {</span>

    private Intent intent;
    private HashMap&lt;Integer, ViolationListAdapter&gt; adapters;
    private String restaurantTrackingID;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L45">        super.onCreate(savedInstanceState);</span>
<span class="fc" id="L46">        setContentView(R.layout.activity_restaurant_detail);</span>
<span class="fc" id="L47">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span>
<span class="fc" id="L48">        setSupportActionBar(toolbar);</span>
<span class="fc" id="L49">        intent = getIntent();</span>
<span class="fc" id="L50">        setTitle(intent.getStringExtra(getString(R.string.intent_extra_restaurant_name)));</span>

<span class="fc" id="L52">        getSupportActionBar().setDisplayHomeAsUpEnabled(true);</span>

        // Disable &quot;Drag&quot; for AppBarLayout (i.e. User can't scroll appBarLayout by directly touching
        // appBarLayout - User can only scroll appBarLayout by only using scrollContent)
<span class="fc" id="L56">        AppBarLayout mAppBarLayout = (AppBarLayout) findViewById(R.id.app_bar);</span>
<span class="fc" id="L57">        CoordinatorLayout.LayoutParams params = (CoordinatorLayout.LayoutParams) mAppBarLayout.getLayoutParams();</span>
<span class="fc" id="L58">        AppBarLayout.Behavior behavior = new AppBarLayout.Behavior();</span>
<span class="fc" id="L59">        behavior.setDragCallback(new AppBarLayout.Behavior.DragCallback() {</span>
            @Override
            public boolean canDrag(AppBarLayout appBarLayout) {
<span class="fc" id="L62">                return false;</span>
            }
        });
<span class="fc" id="L65">        params.setBehavior(behavior);</span>

<span class="fc" id="L67">        restaurantTrackingID = intent.getStringExtra(getString(R.string.intent_extra_restaurant_ID));</span>
<span class="fc" id="L68">        ArrayList&lt;InspectionResult&gt; results = BrowseActivity.inspectionData.get(restaurantTrackingID);</span>
<span class="fc" id="L69">        InspectionListAdapter adapter = new InspectionListAdapter(this, results);</span>

<span class="fc" id="L71">        adapters = new HashMap&lt;&gt;();</span>

        // Adds all inspection data for the current restaurant to a linear layout
<span class="fc" id="L74">        LinearLayout linearLayout = (LinearLayout) findViewById(R.id.inspection_linear_layout);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (int i = 0; i &lt; adapter.getCount(); i++) {</span>
<span class="fc" id="L76">            View item = adapter.getView(i, null, null);</span>
<span class="fc" id="L77">            linearLayout.addView(item);</span>
<span class="fc" id="L78">            InspectionResult inspection = adapter.getItem(i);</span>

            // Put each inspection's list of violations into a hashmap indexed by its position
            // in the adapter. Necessary to build the violation listview when an inspection item
            // is clicked by the user.
<span class="fc" id="L83">            adapters.put(i, new ViolationListAdapter(this, inspection.violations));</span>

<span class="fc" id="L85">            item.setOnClickListener(new View.OnClickListener()</span>
<span class="fc" id="L86">            {</span>
                @Override
                public void onClick(View v) {
                    // When an inspection item is clicked, build and show an alert dialog with a list
                    // of the violations.
<span class="fc" id="L91">                    AlertDialog.Builder dialogBuilder = new AlertDialog.Builder(RestaurantDetailActivity.this);</span>
<span class="fc" id="L92">                    Integer position = ((ViewGroup) v.getParent()).indexOfChild(v);</span>

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">                    if (adapters.get(position).getCount() &lt; 1)</span>
                    {
<span class="nc" id="L96">                        dialogBuilder.setMessage(&quot;No violations&quot;);</span>
                    }
                    else
                    {
<span class="fc" id="L100">                        LayoutInflater inflater = RestaurantDetailActivity.this.getLayoutInflater();</span>
<span class="fc" id="L101">                        View dialogView = inflater.inflate(R.layout.content_violation, null);</span>
<span class="fc" id="L102">                        ListView violationsList = (ListView) dialogView.findViewById(R.id.listview_violations);</span>
<span class="fc" id="L103">                        violationsList.setAdapter(adapters.get(position));</span>
<span class="fc" id="L104">                        dialogBuilder.setView(dialogView);</span>
                    }

<span class="fc" id="L107">                    dialogBuilder.setPositiveButton(&quot;OK&quot;, null);</span>
<span class="fc" id="L108">                    dialogBuilder.setTitle(&quot;Violations&quot;);</span>
<span class="fc" id="L109">                    AlertDialog alertDialog = dialogBuilder.create();</span>
<span class="fc" id="L110">                    alertDialog.show();</span>
<span class="fc" id="L111">                }</span>
            });
        }

        // Set the address and hazard details text for the restaurant.
<span class="fc" id="L116">        ((TextView) findViewById(R.id.restaurant_address_text)).setText(intent.getStringExtra(getString(R.string.intent_extra_restaurant_address)) + &quot;, Surrey BC&quot;);</span>
<span class="fc" id="L117">        ((TextView) findViewById(R.id.restaurant_name_text)).setText(intent.getStringExtra(getString(R.string.intent_extra_restaurant_name)));</span>
<span class="fc" id="L118">        HazardRating hazard = (HazardRating) intent.getSerializableExtra(getString(R.string.intent_extra_restaurant_hazard));</span>
<span class="fc" id="L119">        TextView hazardText = (TextView) findViewById(R.id.restaurant_hazard_text);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (hazard == HazardRating.SAFE)</span>
        {
<span class="fc" id="L122">            hazardText.setTextColor(getColor(R.color.colorLowHazard));</span>
<span class="fc" id="L123">            hazardText.setText(getString(R.string.low_hazard));</span>
        }
<span class="nc bnc" id="L125" title="All 2 branches missed.">        else if (hazard == HazardRating.MODERATE)</span>
        {
<span class="nc" id="L127">            hazardText.setTextColor(getColor(R.color.colorModerateHazard));</span>
<span class="nc" id="L128">            hazardText.setText(getString(R.string.mod_hazard));</span>
        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">        else if (hazard == HazardRating.UNSAFE)</span>
        {
<span class="nc" id="L132">            hazardText.setTextColor(getColor(R.color.colorHighHazard));</span>
<span class="nc" id="L133">            hazardText.setText(getString(R.string.high_hazard));</span>
        }
        else
        {
<span class="nc" id="L137">            hazardText.setTextColor(getColor(R.color.greyFont));</span>
<span class="nc" id="L138">            hazardText.setText(getString(R.string.unknown_hazard));</span>
        }

        // Creates a Google map fragment on the layout with a marker at the restaurant location.
<span class="fc" id="L142">        ((MapFragment)getFragmentManager().findFragmentById(R.id.map)).getMapAsync(new OnMapReadyCallback() {</span>
            @Override
            public void onMapReady(GoogleMap googleMap) {
<span class="fc" id="L145">                Double lat = intent.getDoubleExtra(getString(R.string.intent_extra_restaurant_lat), 0);</span>
<span class="fc" id="L146">                Double longi = intent.getDoubleExtra(getString(R.string.intent_extra_restaurant_long), 0);</span>
<span class="fc" id="L147">                CameraUpdate restaurantLocation = CameraUpdateFactory.newLatLngZoom(new LatLng(lat, longi), 15);</span>
<span class="fc" id="L148">                googleMap.moveCamera(restaurantLocation);</span>
<span class="fc" id="L149">                googleMap.addMarker(new MarkerOptions().position(new LatLng(lat, longi)).title(intent.getStringExtra(getString(R.string.intent_extra_restaurant_name))));</span>

<span class="fc" id="L151">                googleMap.getUiSettings().setMapToolbarEnabled(true);</span>
<span class="fc" id="L152">            }</span>
        });
<span class="fc" id="L154">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
<span class="fc" id="L159">        getMenuInflater().inflate(R.menu.menu_restaurant_detail, menu);</span>

<span class="fc" id="L161">        SharedPreferences faveSharedPref = getSharedPreferences(getString(R.string.shared_pref_fave_list), MODE_PRIVATE);</span>
<span class="fc" id="L162">        String faveRestaurants = faveSharedPref.getString(getString(R.string.faved_restaurants), &quot;&quot;);</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if (faveRestaurants.contains(restaurantTrackingID))</span>
        {
<span class="nc" id="L165">            menu.getItem(0).setIcon(R.drawable.ic_action_fave);</span>
        }
        else
        {
<span class="fc" id="L169">            menu.getItem(0).setIcon(R.drawable.ic_action_fave_border);</span>
        }
<span class="fc" id="L171">        return true;</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="fc" id="L176">        int id = item.getItemId();</span>

        // Handles action when user favorites or unfavorites an restaurant.
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (id == R.id.action_fave)</span>
        {
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (item.getIcon().getConstantState().equals(getDrawable(R.drawable.ic_action_fave_border).getConstantState()))</span>
            {
<span class="fc" id="L183">                addToFaveList(restaurantTrackingID);</span>
<span class="fc" id="L184">                item.setIcon(R.drawable.ic_action_fave);</span>
<span class="fc" id="L185">                Toast toast = Toast.makeText(this, &quot;Added to Favorites&quot;, Toast.LENGTH_LONG);</span>
<span class="fc" id="L186">                toast.show();</span>
<span class="fc" id="L187">            }</span>
            else
            {
<span class="fc" id="L190">                removeFromFaveList(restaurantTrackingID);</span>
<span class="fc" id="L191">                item.setIcon(R.drawable.ic_action_fave_border);</span>
<span class="fc" id="L192">                Toast toast = Toast.makeText(this, &quot;Removed from Favorites&quot;, Toast.LENGTH_LONG);</span>
<span class="fc" id="L193">                toast.show();</span>
<span class="fc" id="L194">            }</span>
        }
        // Go to the previous activity when app bar's home/up button is pressed.
<span class="nc bnc" id="L197" title="All 2 branches missed.">        else if (id == android.R.id.home)</span>
        {
<span class="nc" id="L199">            onBackPressed();</span>
<span class="nc" id="L200">            return true;</span>
        }

<span class="fc" id="L203">        return super.onOptionsItemSelected(item);</span>
    }

    // Adds a restaurant tracking ID to a shared preference string that represents a comma-separated
    // list of user's favorite restaurants.
    private void addToFaveList(String trackingID)
    {
<span class="fc" id="L210">        SharedPreferences faveSharedPref = getSharedPreferences(getString(R.string.shared_pref_fave_list), MODE_PRIVATE);</span>
<span class="fc" id="L211">        String faveRestaurants = faveSharedPref.getString(getString(R.string.faved_restaurants), &quot;&quot;);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (faveRestaurants.length() == 0)</span>
        {
<span class="fc" id="L214">            faveSharedPref.edit().putString(getString(R.string.faved_restaurants), trackingID).commit();</span>
        }
        else
        {
<span class="nc" id="L218">            faveSharedPref.edit().putString(getString(R.string.faved_restaurants), faveRestaurants + &quot;,&quot; + trackingID).commit();</span>
        }
<span class="fc" id="L220">    }</span>

    // Removes a restaurant tracking ID to a shared preference string that represents a
    // comma-separated list of user's favorite restaurants.
    private void removeFromFaveList(String trackingID)
    {
<span class="fc" id="L226">        SharedPreferences faveSharedPref = getSharedPreferences(getString(R.string.shared_pref_fave_list), MODE_PRIVATE);</span>
<span class="fc" id="L227">        String faveRestaurants = faveSharedPref.getString(getString(R.string.faved_restaurants), &quot;&quot;);</span>
<span class="fc" id="L228">        String newFaveList = &quot;&quot;;</span>


<span class="fc" id="L231">        Integer index = faveRestaurants.indexOf(trackingID);</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (index == -1)</span>
        {
<span class="nc" id="L234">            return;</span>
        }
        // Handles cases where tracking ID comes 2nd or later in the comma-separated list
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        else if(faveRestaurants.contains(&quot;,&quot; + trackingID))</span>
        {
<span class="nc" id="L239">            newFaveList = faveRestaurants.replace(&quot;,&quot; + trackingID, &quot;&quot;);</span>
        }
        // Handles cases where tracking ID comes 1st in the comma-separated list
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">        else if (faveRestaurants.contains(trackingID + &quot;,&quot;))</span>
        {
<span class="nc" id="L244">            newFaveList = faveRestaurants.replace(trackingID + &quot;,&quot;, &quot;&quot;);</span>
        }
        // Handles cases where tracking ID is the only value in the list (i.e. there are no commas)
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        else if (faveRestaurants.contains(trackingID))</span>
        {
<span class="fc" id="L249">            newFaveList = faveRestaurants.replace(trackingID, &quot;&quot;);</span>
        }

<span class="fc" id="L252">        faveSharedPref.edit().putString(getString(R.string.faved_restaurants), newFaveList).commit();</span>
<span class="fc" id="L253">    }</span>



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>